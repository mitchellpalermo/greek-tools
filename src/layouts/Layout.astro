---
import '../styles/global.css';
import { isDrillsEnabled } from '../lib/features';

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Free tools for Koine Greek students — keyboard, flashcards, and more." } = Astro.props;

// Astro.locals.runtime is only available on SSR pages; use optional chaining
// so this layout renders correctly on statically pre-rendered pages too.
// PUBLIC_DRILLS_ENABLED is a Vite env fallback so `astro dev` can show the nav entry.
const drillsOn =
  isDrillsEnabled(Astro.locals.runtime?.env) ||
  import.meta.env.PUBLIC_DRILLS_ENABLED === 'true';

const navLinks = [
  { href: '/keyboard',        label: 'Keyboard',        tabLabel: 'Keys'      },
  { href: '/flashcards',      label: 'Flashcards',      tabLabel: 'Cards'     },
  { href: '/daily',           label: 'Daily',           tabLabel: 'Daily'     },
  { href: '/reader',          label: 'Reader',          tabLabel: 'Reader'    },
  { href: '/transliteration', label: 'Transliteration', tabLabel: 'Translit'  },
  { href: '/grammar',         label: 'Grammar',         tabLabel: 'Grammar'   },
  { href: '/paradigms',       label: 'Quiz',            tabLabel: 'Quiz'      },
  ...(drillsOn ? [{ href: '/drills', label: 'Drills', tabLabel: 'Drills' }] : []),
];

const currentPath = Astro.url.pathname;

function isActive(href: string) {
  return currentPath.startsWith(href);
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title} | greek.tools</title>

    <!-- Google Fonts: Plus Jakarta Sans (all UI) + Noto Sans (Greek text rendering) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="bg-bg text-text min-h-screen flex flex-col">

    <!-- ── Rainbow accent line at top of page ─────────────────────────── -->
    <div
      class="h-1 w-full"
      style="background: linear-gradient(90deg, #1D4ED8 0%, #7C3AED 30%, #F43F5E 55%, #F59E0B 75%, #059669 100%);"
    ></div>

    <!-- ── Nav ────────────────────────────────────────────────────────── -->
    <nav class="bg-primary text-white px-4 sm:px-6 py-4 shadow-md">
      <div class="max-w-5xl mx-auto flex items-center justify-between">

        <!-- Logo -->
        <a
          href="/"
          class="group flex items-baseline gap-0 hover:opacity-90 transition-opacity"
          aria-label="greek.tools home"
        >
          <span class="text-xl font-extrabold tracking-tight leading-none">
            greek
          </span>
          <span class="text-xl font-extrabold tracking-tight leading-none text-accent-light">
            .tools
          </span>
        </a>

        <!-- Desktop nav links (hidden on mobile — replaced by bottom tab bar) -->
        <div class="hidden md:flex gap-1">
          {navLinks.map(({ href, label }) => (
            <a
              href={href}
              class={[
                'px-3 py-1.5 rounded-md text-sm font-semibold transition-colors',
                isActive(href)
                  ? 'bg-white/20 text-white'
                  : 'text-white/80 hover:text-white hover:bg-white/10',
              ].join(' ')}
              aria-current={isActive(href) ? 'page' : undefined}
            >
              {label}
            </a>
          ))}
        </div>

      </div>
    </nav>

    <!-- ── Main content ────────────────────────────────────────────────── -->
    <!-- pb-20 on mobile leaves room above the fixed bottom tab bar -->
    <main class="flex-1 max-w-5xl mx-auto w-full px-4 sm:px-6 py-6 sm:py-8 pb-20 md:pb-8">
      <slot />
    </main>

    <!-- ── Footer (desktop only — bottom tab bar serves as nav on mobile) ── -->
    <footer class="hidden md:block bg-primary text-white/60 text-sm text-center py-5">
      <p>
        greek.tools — free utilities for Koine Greek students
        <span class="mx-2 opacity-40">·</span>
        <!-- Easter egg: ὁπλον means "tool" in ancient Greek -->
        <span class="group relative inline-block cursor-help">
          <span
            class="opacity-30 group-hover:opacity-100 transition-all duration-300 group-hover:text-accent-light"
            style="font-family: var(--font-greek);"
          >
            ὁπλον
          </span>
          <span class="
            pointer-events-none absolute bottom-full left-1/2 -translate-x-1/2 mb-2
            bg-text text-white text-xs px-3 py-1.5 rounded-lg whitespace-nowrap
            opacity-0 group-hover:opacity-100 transition-opacity duration-200
            shadow-lg
          ">
            ancient Greek for <em>"tool"</em>
          </span>
        </span>
      </p>
    </footer>

    <!-- ── Mobile bottom tab bar (hidden on md+) ──────────────────────── -->
    <nav
      class="fixed bottom-0 inset-x-0 md:hidden z-50 bg-primary border-t border-white/10"
      style="padding-bottom: env(safe-area-inset-bottom, 0px)"
      aria-label="Main navigation"
    >
      <!-- Thin rainbow line mirrors the page top accent -->
      <div
        class="h-px w-full"
        style="background: linear-gradient(90deg, #1D4ED8 0%, #7C3AED 30%, #F43F5E 55%, #F59E0B 75%, #059669 100%);"
      ></div>

      <div class="flex justify-around items-stretch h-[72px]">

        <!-- Keyboard -->
        <a
          href="/keyboard"
          class:list={["tab-item", isActive('/keyboard') ? "tab-active" : "tab-inactive"]}
          aria-label="Greek Keyboard"
          aria-current={isActive('/keyboard') ? 'page' : undefined}
        >
          <span class:list={["tab-pill", { "tab-pill-active": isActive('/keyboard') }]}>
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="2" y="6" width="20" height="12" rx="2" ry="2"/>
              <circle cx="6" cy="10" r="1" fill="currentColor" stroke="none"/>
              <circle cx="10" cy="10" r="1" fill="currentColor" stroke="none"/>
              <circle cx="14" cy="10" r="1" fill="currentColor" stroke="none"/>
              <circle cx="18" cy="10" r="1" fill="currentColor" stroke="none"/>
              <circle cx="8" cy="14" r="1" fill="currentColor" stroke="none"/>
              <circle cx="12" cy="14" r="1" fill="currentColor" stroke="none"/>
              <circle cx="16" cy="14" r="1" fill="currentColor" stroke="none"/>
            </svg>
            <span class="tab-label">Keys</span>
          </span>
        </a>

        <!-- Flashcards -->
        <a
          href="/flashcards"
          class:list={["tab-item", isActive('/flashcards') ? "tab-active" : "tab-inactive"]}
          aria-label="Flashcards"
          aria-current={isActive('/flashcards') ? 'page' : undefined}
        >
          <span class:list={["tab-pill", { "tab-pill-active": isActive('/flashcards') }]}>
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="2" y="6" width="20" height="14" rx="2"/>
              <path d="M16 6V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/>
              <line x1="12" y1="11" x2="12" y2="16"/>
              <line x1="9.5" y1="13.5" x2="14.5" y2="13.5"/>
            </svg>
            <span class="tab-label">Cards</span>
          </span>
        </a>

        <!-- Daily verse -->
        <a
          href="/daily"
          class:list={["tab-item", isActive('/daily') ? "tab-active" : "tab-inactive"]}
          aria-label="Daily Verse"
          aria-current={isActive('/daily') ? 'page' : undefined}
        >
          <span class:list={["tab-pill", { "tab-pill-active": isActive('/daily') }]}>
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="4"/>
              <line x1="12" y1="2" x2="12" y2="5"/>
              <line x1="12" y1="19" x2="12" y2="22"/>
              <line x1="4.22" y1="4.22" x2="6.34" y2="6.34"/>
              <line x1="17.66" y1="17.66" x2="19.78" y2="19.78"/>
              <line x1="2" y1="12" x2="5" y2="12"/>
              <line x1="19" y1="12" x2="22" y2="12"/>
              <line x1="4.22" y1="19.78" x2="6.34" y2="17.66"/>
              <line x1="17.66" y1="6.34" x2="19.78" y2="4.22"/>
            </svg>
            <span class="tab-label">Daily</span>
          </span>
        </a>

        <!-- Reader -->
        <a
          href="/reader"
          class:list={["tab-item", isActive('/reader') ? "tab-active" : "tab-inactive"]}
          aria-label="Reader"
          aria-current={isActive('/reader') ? 'page' : undefined}
        >
          <span class:list={["tab-pill", { "tab-pill-active": isActive('/reader') }]}>
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
              <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
            <span class="tab-label">Reader</span>
          </span>
        </a>

        <!-- Transliteration -->
        <a
          href="/transliteration"
          class:list={["tab-item", isActive('/transliteration') ? "tab-active" : "tab-inactive"]}
          aria-label="Transliteration"
          aria-current={isActive('/transliteration') ? 'page' : undefined}
        >
          <span class:list={["tab-pill", { "tab-pill-active": isActive('/transliteration') }]}>
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="4 7 4 4 20 4 20 7"/>
              <line x1="9" y1="20" x2="15" y2="20"/>
              <line x1="12" y1="4" x2="12" y2="20"/>
            </svg>
            <span class="tab-label">Translit</span>
          </span>
        </a>

        <!-- Grammar -->
        <a
          href="/grammar"
          class:list={["tab-item", isActive('/grammar') ? "tab-active" : "tab-inactive"]}
          aria-label="Grammar Reference"
          aria-current={isActive('/grammar') ? 'page' : undefined}
        >
          <span class:list={["tab-pill", { "tab-pill-active": isActive('/grammar') }]}>
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
              <line x1="9" y1="7" x2="15" y2="7"/>
              <line x1="9" y1="11" x2="15" y2="11"/>
            </svg>
            <span class="tab-label">Grammar</span>
          </span>
        </a>

        <!-- Paradigm Quiz -->
        <a
          href="/paradigms"
          class:list={["tab-item", isActive('/paradigms') ? "tab-active" : "tab-inactive"]}
          aria-label="Paradigm Quiz"
          aria-current={isActive('/paradigms') ? 'page' : undefined}
        >
          <span class:list={["tab-pill", { "tab-pill-active": isActive('/paradigms') }]}>
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            <span class="tab-label">Quiz</span>
          </span>
        </a>

        {/* Drills tab — only rendered when feature flag is on */}
        {drillsOn && (
          <a
            href="/drills"
            class:list={["tab-item", isActive('/drills') ? "tab-active" : "tab-inactive"]}
            aria-label="Parsing Drills"
            aria-current={isActive('/drills') ? 'page' : undefined}
          >
            <span class:list={["tab-pill", { "tab-pill-active": isActive('/drills') }]}>
              <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
              </svg>
              <span class="tab-label">Drills</span>
            </span>
          </a>
        )}

      </div>
    </nav>

  </body>
</html>

<style>
  .tab-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    text-decoration: none;
    transition: color 150ms ease;
    -webkit-tap-highlight-color: transparent;
    min-width: 0;
  }

  .tab-active {
    color: var(--color-accent-light);
  }

  .tab-inactive {
    color: rgb(255 255 255 / 0.45);
  }

  .tab-inactive:hover {
    color: rgb(255 255 255 / 0.75);
  }

  .tab-pill {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 4px 6px;
    border-radius: 10px;
    transition: background-color 150ms ease;
    width: 100%;
  }

  .tab-pill-active {
    background-color: rgb(245 158 11 / 0.18);
  }

  .tab-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.02em;
    line-height: 1;
    white-space: nowrap;
  }
</style>
